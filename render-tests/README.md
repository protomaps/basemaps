# Render Tests

## Usage

Use the node version in the nvmrc file with `nvm use`.

First build the styles package locally:

```
cd ../styles
npm ci
npm run build
```

Then install the dependencies in the render-test folder with:

```
npm ci
```

Then build the render test runner:

```
npm run build
```

The render test runner is now ready, but we still need to generate some pmtiles with:

```
./generate_pmtiles.sh
```

You should now have a folder `pmtiles`.

Then run the render tests with:

```
npm run test
```

This will create a `results.html` file. Have a look at it with something like

```
npx serve .
```

## Updating Tests

When `expected.png` images should change, you can tell the render test runner to copy the `actual.png` to the `expected.png` images with:

```
UPDATE=true npm run test
```

## Adding Tests

Tests use a minimal OpenStreetMap extract which contains only the data needed for a test scenario.

First, download an extract with https://slice.openstreetmap.us and save it in `tests/<layer-name>/<test-name>/input-unfiltered.osm.pbf`. Example: a test for rivers in tunnels could look like this: `tests/water/tunnel/input-unfiltered.osm.pbf`

Then, use osmium to extract only the source features that you need for the test and save it in `tests/<layer-name>/<test-name>`. Example: extract the waterways for the river in tunnel example:

```
cd tests/water/tunnel
osmium tags-filter input-unfiletered.osm.pbf "nwr/waterway" -o input.osm.pbf
```

The OpenStreetMap input data for the test is now ready. The `generate_pmtiles.sh` script will take `input.osm.pbf`, merge it with the other inputs, and generate `pmtiles/tiles.pmtiles`. Note that spatially overlapping inputs will influence eachother's outputs. If you want to only work with a single test, use
```
./generate_pmtiles.sh tests/<layer-name>/<test-name>
```

Create a `tests/<layer-name>/<test-name>/style.json` file containing the center position, zoom, and pixel size. Optionally include a link to a GitHub Issue. Example: `tests/water/tunnel/style.json`:

```json
{
  "version": 8,
  "metadata": {
    "test": {
      "width": 256,
      "height": 256,
      "flavor": "light",
      "lang": "en"
    },
    "link": "https://github.com/protomaps/basemaps/issues/481"
  },
  "center": [
    6.088001,
    50.775976
  ],
  "zoom": 16
}
```

Run the tests with the update flag to generate a new `tests/<layer-name>/<test-name>/expected.png` file:

```
UPDATE=true npm run test
```

Commit `expected.png`, `style.json`, and `input.osm.pbf` with Git.


## Looking at CI `results.html`

The `results.html` generated by GitHub actions runners can be downloaded at the end of the run. The html file will be inside a zip container. This can be convenient to get access to exactly the pixels that are generate in CI.

## License

The code in this folder has been derived from the render tests of MapLibre GL, a fork of Mapbox GL. The license therefore is based on MapLibre's license (BSD), see [LICENSE.md](./LICENSE.md).
